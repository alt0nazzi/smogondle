<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white">
<head>
  <meta charset="UTF-8">
  <title>Smogondle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script>
    async function updateSuggestions(value) {
      const res = await fetch(`/autocomplete?q=${value}`);
      const names = await res.json();
      const datalist = document.getElementById("pokemon-list");
      datalist.innerHTML = "";
      names.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        datalist.appendChild(option);
      });
    }
  </script>
  {% if trigger_reward_glow %}
  <script>
    window.addEventListener('load', () => {
      const header = document.getElementById('reward-header');
      if (header) {
        header.classList.add('glow-on-correct');
        setTimeout(() => {
          header.classList.remove('glow-on-correct');
        }, 1600);
      }
    });
  </script>
  <script>
  window.addEventListener('load', () => {
    const header = document.getElementById('reward-header');
    if (header) {
      header.classList.add('glow-on-correct');

      // Create particles
      for (let i = 0; i < 12; i++) {
        const particle = document.createElement('span');
        particle.className = 'reward-particle';
        const angle = Math.random() * 2 * Math.PI;
        const radius = Math.random() * 60 + 30;
        const x = Math.cos(angle) * radius;
        const y = Math.sin(angle) * radius;

        particle.style.setProperty('--x', `${x}px`);
        particle.style.setProperty('--y', `${y}px`);

        header.appendChild(particle);

        setTimeout(() => particle.remove(), 1000);
      }

      setTimeout(() => {
        header.classList.remove('glow-on-correct');
      }, 1000);
    }
  });
</script>
  {% endif %}
  <style>
    html {
      overflow-y: scroll;
    }

    @keyframes pop-in {0% {opacity: 0; transform: scale(0.8) translateY(10px);} 100% {opacity: 1; transform: scale(1) translateY(0);}}

    @keyframes bounce-flip {0% {transform: rotateY(0deg) scale(1);} 50% {transform: rotateY(90deg) scale(1.2);} 100% {transform: rotateY(180deg) scale(1);}}

    @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

    @keyframes shake {
          0% { transform: translateX(0); }
          25% { transform: translateX(-4px); }
          50% { transform: translateX(4px); }
          75% { transform: translateX(-4px); }
          100% { transform: translateX(0); }
        }

    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    @keyframes fade-in {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .correct-float {
      position: absolute;
      font-size: 1.25rem;
      font-weight: 800;
      color: #facc15; /* Tailwind yellow-400 */
      text-shadow: 0 0 8px #facc15;
      animation: float-up 1.5s ease-out forwards;
      pointer-events: none;
      z-index: 30;
    }

    @keyframes reward-pop-glow-green {
      0% {
        transform: scale(1);
        text-shadow: none;
      }
      50% {
        transform: scale(1.2);
        text-shadow: 0 0 4px #4ade80, 0 0 8px #4ade80;
      }
      100% {
        transform: scale(1);
        text-shadow: none;
      }
    }

    #reward-header.glow-on-correct {
      animation: reward-pop-glow-green 1s ease-in-out;
      position: relative; /* for particle absolute positioning */
    }

    .reward-particle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 6px;
      height: 6px;
      background: #4ade80; /* green glow */
      border-radius: 50%;
      opacity: 0.9;
      transform: translate(-50%, -50%);
      animation: particle-burst 0.8s ease-out forwards;
      pointer-events: none;
      z-index: 10;
    }

    @keyframes particle-burst {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(var(--x), var(--y)) scale(0.4);
        opacity: 0;
      }
    }

    .animate-fade-in {
      animation: fade-in 0.5s forwards;
    }

    .animate-pop {
      animation: pop 0.4s ease;
    }

    .animate-shake {
      animation: shake 0.4s ease;
    }
    .animate-fade-in {
      animation: fade-in 0.4s ease-out forwards;
    }
    .type-icon {
      height: 32px;
      width: 32px;
      border-radius: 9999px;
      margin-right: 8px;
      border: 2px solid #555;
      background: #1f2937;
    }
    .perspective {
      perspective: 1000px;
    }
    .flip-card-inner {
      animation: bounce-flip 0.8s ease-out forwards;
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.8s;
      transform: rotateY(180deg);
    }
    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 0.75rem;
    }
    .flip-card-back {
      transform: rotateY(180deg);
    }

    @keyframes busy-drift {
      0% {
        transform: translate(0px, 0px) scale(1) rotate(0deg);
        opacity: 0.12;
      }
      25% {
        transform: translate(30px, 20px) scale(1.03) rotate(0.5deg);
        opacity: 0.14;
      }
      50% {
        transform: translate(-20px, 30px) scale(1.05) rotate(-0.5deg);
        opacity: 0.16;
      }
      75% {
        transform: translate(25px, -20px) scale(1.02) rotate(0.3deg);
        opacity: 0.13;
      }
      100% {
        transform: translate(0px, 0px) scale(1) rotate(0deg);
        opacity: 0.12;
      }
    }
    .animate-busy-drift {
      animation: busy-drift 60s ease-in-out infinite;
    }

    @keyframes fall {
      0% {
        transform: translateY(0) translateX(0);
        opacity: 0.5; /* start more subtle */
      }
      100% {
        transform: translateY(100vh) translateX(30px);
        opacity: 0; /* fade to invisible */
      }
    }

    @keyframes fall-slow {
      0% { transform: translateY(0) translateX(0); opacity: 0.4; }
      100% { transform: translateY(100vh) translateX(30px); opacity: 0; }
    }

    @keyframes fall-fast {
      0% { transform: translateY(0) translateX(0); opacity: 0.8; }
      100% { transform: translateY(100vh) translateX(80px); opacity: 0; }
    }

    @keyframes supernova-flash {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.8;
      }
      100% {
        transform: scale(1.8);
        opacity: 0;
      }
    }

    @keyframes fly-across {
      0% {
        transform: translateX(-100px) translateY(0) rotate(0deg) scale(1);
        opacity: 0;
      }
      10% {
        opacity: 0.8;
      }
      90% {
        opacity: 0.8;
      }
      100% {
        transform: translateX(110vw) translateY(-30px) rotate(5deg) scale(1.1);
        opacity: 0;
      }
    }

    @keyframes sparkle {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    .flying-star {
      position: absolute;
      top: 20%;
      left: -100px;
      width: 80px;
      height: 80px;
      background: url('/static/star.png') no-repeat center center;
      background-size: contain;
      opacity: 0.3;
      animation: fly-across 15s linear forwards, sparkle 1.5s ease-in-out infinite;
      pointer-events: none;
      z-index: -4;
    }

    /* Regular faint star */
    .falling-star {
      position: absolute;
      top: 0;
      width: 1px;
      height: 60px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.6), transparent);
      animation: fall-slow 5s linear forwards;
      opacity: 0.6;
      pointer-events: none;
      z-index: -5;
    }

    /* Rare bright star */
    .bright-star {
      position: absolute;
      top: 0;
      width: 2px;
      height: 90px;
      background: linear-gradient(to bottom, rgba(255,255,255,1), transparent);
      animation: fall-fast 3s linear forwards;
      opacity: 1;
      pointer-events: none;
      z-index: -5;
    }

    .falling-star {
      position: absolute;
      top: 0; /* Always start at top! */
      width: 1px;
      height: 60px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.6), transparent);
      opacity: 0.6; /* overall more subtle */
      animation: fall 3s linear forwards;
      pointer-events: none;
      z-index: -5;
    }

    @keyframes score-pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    .animate-score-pop {
      animation: score-pop 0.5s ease;
      }

    @keyframes float-up {
      0% {
        transform: translateY(0);
        opacity: 1;
      }
      100% {
        transform: translateY(-40px);
        opacity: 0;
      }
    }

    @keyframes glow-pulse {
      0%   { transform: scale(1); text-shadow: 0 0 4px #4ade80; }
      50%  { transform: scale(1.2); text-shadow: 0 0 20px #4ade80, 0 0 30px #4ade80; }
      100% { transform: scale(1); text-shadow: 0 0 4px #4ade80; }
    }
    .glow-on-correct {
      animation: glow-pulse 0.4s ease-in-out;
    }

  .floating-points {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.5rem;
    font-weight: bold;
    color: #7dd3fc; /* light cyan */
    text-shadow: 0 0 8px #7dd3fc;
    animation: float-up 1.5s ease-out forwards;
    pointer-events: none;
    z-index: 20;
  }

  @keyframes slide-fade-up {
    0% {
      transform: translateY(50px);
      opacity: 0;
    }
    100% {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .animate-slide-fade-up {
    animation: slide-fade-up 0.5s ease-out forwards;
  }

  @keyframes click-pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  .animate-click-pop {
    animation: click-pop 0.3s ease;
  }

  body {
    background: url('/static/background-nebula.jpg') no-repeat center center;
    background-size: cover;
    background-attachment: fixed;
    background-color: #030712; /* Deep cosmic fallback */
    overflow-x: hidden;
  }

  .page-fade {
    opacity: 0;
    transition: opacity 0.8s ease-in-out;
  }

  .page-fade.loaded {
    opacity: 1;
  }

  #cinematics-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    min-height: 100%;
    background: url('/static/nebula.png') no-repeat center center;
    background-size: cover;
    background-attachment: fixed;
    animation: busy-drift 60s ease-in-out infinite;
    z-index: 0;
    background-blend-mode: screen;
    filter: brightness(1.2) contrast(1.1);
  }

  .default-theme {
    background: url('/static/background-nebula.jpg') no-repeat center center;
    background-size: cover;
    background-attachment: fixed;
    background-color: #030712;
  }

  .theme-celestial {
    background: linear-gradient(to right, #1e3c72, #2a5298);
    background-attachment: fixed;
    color: #e0e0ff;
  }

  .theme-stardust {
    background: radial-gradient(circle at top left, #3b82f6, #1e1b4b);
    background-attachment: fixed;
    color: #ffffff;
  }

  .strategy-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 5rem;
    font-weight: 800;
    opacity: 0.1;
    pointer-events: none;
    user-select: none;
    z-index: 0;
    color: white;
  }

  #cinematics-layer::before {
    content: "";
    position: absolute;
    inset: 0;
    background: url('/static/starfield-overlay.png') repeat;
    opacity: 0.08;
    pointer-events: none;
    z-index: -1;
  }

  @keyframes fly-left-up {
    0% { transform: translate(0, 0); opacity: 1; }
    100% { transform: translate(-80px, -40px); opacity: 0; }
  }

  @keyframes fly-right-up {
    0% { transform: translate(0, 0); opacity: 1; }
    100% { transform: translate(80px, -40px); opacity: 0; }
  }

  .fly-left {
    animation: fly-left-up 1.2s ease-out forwards;
    position: absolute;
    left: 40%;
    top: 0;
    font-size: 1.25rem;
    font-weight: bold;
    color: #7dd3fc;
    text-shadow: 0 0 8px #7dd3fc;
    pointer-events: none;
  }

  .fly-right {
    animation: fly-right-up 1.2s ease-out forwards;
    position: absolute;
    right: 40%;
    top: 0;
    font-size: 1.25rem;
    font-weight: bold;
    color: #facc15;
    text-shadow: 0 0 8px #facc15;
    pointer-events: none;
  }

  @keyframes fly-left-fast {
    0% { transform: translate(0, 0); opacity: 1; }
    100% { transform: translate(-100px, -40px); opacity: 0; }
  }

  @keyframes fly-left-medium {
    0% { transform: translate(0, 0); opacity: 1; }
    100% { transform: translate(-80px, -60px); opacity: 0; }
  }

  @keyframes fly-right-fast {
    0% { transform: translate(0, 0); opacity: 1; }
    100% { transform: translate(100px, -40px); opacity: 0; }
  }

  @keyframes fly-right-slow {
    0% { transform: translate(0, 0); opacity: 1; }
    100% { transform: translate(80px, -60px); opacity: 0; }
  }

  .fly-left-fast {
    position: absolute;
    left: 40%;
    top: 0;
    font-size: 1.25rem;
    font-weight: bold;
    animation: fly-left-fast 1.1s ease-out forwards;
    pointer-events: none;
    z-index: 25;
  }

  .fly-left-medium {
    position: absolute;
    left: 40%;
    top: 10px;
    font-size: 1.25rem;
    font-weight: bold;
    animation: fly-left-medium 1.4s ease-out forwards;
    pointer-events: none;
    z-index: 26;
  }

  .fly-right-fast {
    position: absolute;
    right: 40%;
    top: 0;
    font-size: 1.25rem;
    font-weight: bold;
    animation: fly-right-fast 1.1s ease-out forwards;
    pointer-events: none;
    z-index: 25;
  }

  .fly-right-slow {
    position: absolute;
    right: 40%;
    top: 10px;
    font-size: 1.25rem;
    font-weight: bold;
    animation: fly-right-slow 1.4s ease-out forwards;
    pointer-events: none;
    z-index: 26;
  }

  @keyframes correct-burst {
    0% {
      transform: scale(0.8) translateY(0);
      opacity: 0;
    }
    30% {
      transform: scale(1.2) translateY(-20px);
      opacity: 1;
    }
    100% {
      transform: scale(1) translateY(-60px);
      opacity: 0;
    }
  }

  @keyframes hint-pop-slide {
    0% {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    50% {
      opacity: 1;
      transform: translateY(-2px) scale(1.05);
    }
    100% {
      transform: translateY(0) scale(1);
    }
  }
  .hint-reveal {
    animation: hint-pop-slide 0.6s ease-out forwards;
  }

  @keyframes hint-toast {
    0% { transform: translateY(20px); opacity: 0; }
    10% { transform: translateY(0); opacity: 1; }
    90% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-20px); opacity: 0; }
  }
  .hint-toast {
    position: fixed;
    top: 100px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #1e293b;
    color: #facc15;
    padding: 12px 20px;
    border-radius: 0.75rem;
    font-weight: 600;
    font-size: 1rem;
    text-shadow: 0 0 6px #facc15;
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.15);
    z-index: 100;
    animation: hint-toast 2.8s ease-in-out forwards;
    pointer-events: none;
  }

  .hint-toast.answer-toast {
    top: 160px; /* offset from default toast */
    background-color: #3b0764; /* Tailwind purple-900 */
    color: #c084fc; /* Tailwind purple-400 */
    text-shadow: 0 0 6px #c084fc;
  }

  .strategy-carousel {
    scrollbar-width: thin;
    scrollbar-color: #64748b #1e293b;
  }

  .strategy-carousel::-webkit-scrollbar {
    height: 6px;
  }
  .strategy-carousel::-webkit-scrollbar-track {
    background: #1e293b;
  }
  .strategy-carousel::-webkit-scrollbar-thumb {
    background-color: #64748b;
    border-radius: 4px;
  }

  .strategy-content {
    max-height: 140px;
    overflow-y: auto;
  }

  </style>
</head>
<body class="{% if fade_in %}page-fade {% endif %}{% if user and user.theme %}theme-{{ user.theme }}{% else %}default-theme{% endif %}">
  <div class="flex flex-col items-center px-4 relative min-h-fit mb-10">
    <div id="cinematics-layer" class="absolute inset-0 pointer-events-none z-0"></div>
    {% if is_daily and not user %}
      <div class="mb-6 px-4 py-3 rounded-lg bg-yellow-500/10 border border-yellow-500 text-yellow-300 text-center text-sm font-medium max-w-2xl mx-auto shadow-lg">
        You're playing the Daily Challenge as a guest. Your score and time will <strong>not</strong> be saved unless you create an account and log in before attempting the challenge.
      </div>
    {% endif %}
    <div class="w-full max-w-2xl mt-12 mb-6 md:mb-8">
      <div class="bg-gray-800 shadow-xl rounded-xl p-6 w-full relative z-10">
        <div class="text-center mb-6">
          <h1 class="text-5xl font-extrabold text-indigo-400 tracking-wide mb-2">
            {% if intro_animation %}
              {% for letter in "Smogondle" -%}
                <span class="inline-block opacity-0 animate-fade-in" style="animation-delay: {{ loop.index0 * 0.1 }}s;">{{ letter }}</span>
              {%- endfor %}
            {% else %}
              Smogondle
            {% endif %}
          </h1>
          <p class="text-base text-gray-400 italic">Guess the Pok√©mon from Smogon forum hints!</p>
        </div>

        <div class="flex flex-wrap justify-center mb-6 gap-4">
          <button onclick="openFilters()" class="px-6 py-2 bg-gradient-to-r from-purple-700 to-indigo-600 text-white rounded-lg hover:brightness-110 transition duration-300">
            Filters
          </button>
          
          {% if is_daily %}
            <a href="/reset" class="ml-4 px-6 py-2 bg-gradient-to-r from-green-600 to-blue-500 text-white rounded-lg hover:brightness-110 transition duration-300">
              Classic Mode
            </a>
          {% else %}
            <a href="/daily" class="ml-4 px-6 py-2 bg-gradient-to-r from-blue-600 to-indigo-500 text-white rounded-lg hover:brightness-110 transition duration-300">
              Daily Challenge!
            </a>
          {% endif %}
          
          <button onclick="openLeaderboard()" class="ml-4 px-6 py-2 bg-gradient-to-r from-green-600 to-blue-500 text-white rounded-lg hover:brightness-110 transition duration-300">
            Leaderboard
          </button>
        </div>      

        <form method="POST" action="/guess" class="flex gap-2 mb-6 w-full">
          <div class="relative flex-1">
            <div class="relative w-full">
              <input
                type="text"
                name="guess"
                id="guess-input"
                list="pokemon-list"
                placeholder=" "
                required
                autocomplete="off"
                oninput="updateSuggestions(this.value)"
                class="peer w-full px-4 py-3.5 rounded-xl bg-gray-700 text-white placeholder-transparent border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200"
              />          
              <label
                for="guess-input"
                class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm transition-all peer-focus:hidden peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-500"
              >
                Enter Pok√©mon...
              </label>
            </div>          
            <datalist id="pokemon-list"></datalist>
          </div>      
          <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700">Guess</button>
          {% if hint_index >= (hints|length - 1) and not image_revealed %}
          <a href="/giveup" class="px-6 py-3.5 bg-gray-600 text-white rounded-xl hover:bg-gray-700 ml-2">Give up?</a>
          {% endif %}
        </form>

        {% if is_daily %}
          <div class="text-center text-cyan-400 text-lg mb-4">
            Daily Challenge - {{ current_date }}
          </div>
        {% endif %}

        <div class="mb-6">
          <h2 class="text-xl font-semibold mb-2">Hints:</h2>
          <ul class="space-y-2">
            {% for hint in hints %}
            {% set delay = loop.index0 * 0.1 %}
              <li class="bg-gray-700 p-2 rounded-lg flex flex-col hint-reveal" style="animation-delay: {{ delay }}s">
                {% if loop.last %}
                <script>
                  const hintLabel = "{{ new_hint_label }}";
                  if (hintLabel === "NoMoreHints") {
                    const toast = document.createElement("div");
                    toast.className = "hint-toast";
                    toast.style.backgroundColor = "#f59e0b";  // amber-500
                    toast.style.color = "#fff";
                    toast.innerHTML = "‚ö†Ô∏è No more hints left to reveal!";
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2800);
                  } else {
                    showHintToast(hintLabel);
                  }
                </script>
                {% endif %}
                {% if hint.label == "Stats" %}
                  <strong class="mb-2">Stats:</strong>
                {% elif hint.label == "Smogon Strategies" and hint.strategies %}
                  <strong class="mb-2">Smogon Strategies:</strong>
                  <details class="bg-gray-700 rounded-md p-3 text-sm animate-pop-in hover:shadow-md transition duration-300">
                    <summary class="cursor-pointer font-semibold text-cyan-300">
                      View Sets
                    </summary>
                    <div class="mt-2 pl-1 flex space-x-4 overflow-x-auto max-w-full strategy-carousel">
                      {% for strategy in hint.strategies %}
                        <div class="min-w-[240px] max-w-xs bg-gray-800 border border-cyan-600 rounded-lg p-3 shadow-md">
                          <h4 class="text-yellow-400 font-bold text-sm mb-1">{{ strategy.label }}</h4>
                          <div class="text-white text-xs strategy-content">
                            {{ strategy.html|safe }}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </details>
                {% else %}
                  <strong class="mb-2">{{ hint.label }}:</strong>
                {% endif %}
                {% if hint.types %}
                <div class="flex flex-wrap">
                  {% for type in hint.types %}
                  <div class="relative group inline-block">
                    <img src="{{ type.url }}" alt="{{ type.name }} Icon" class="h-8 w-8">
                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 rounded bg-gray-800 text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                      {{ type.name }}
                    </div>
                  </div>              
                  {% endfor %}
                </div>
                {% elif hint.html %}
                  {% if hint.label == "Stats" %}
                    <details class="bg-gray-700 rounded-md p-3 text-sm animate-pop-in hover:shadow-md transition duration-300">
                      <summary class="cursor-pointer text-green-300 font-semibold">
                        View Stats
                      </summary>
                      <div class="mt-2 pl-2 text-white">
                        {{ hint.html|safe }}
                      </div>
                    </details>
                  {% elif hint.label == "Smogon Strategies" and hint.strategies %}
                    <details class="bg-gray-700 rounded-md p-3 text-sm animate-pop-in hover:shadow-md transition duration-300">
                      <summary class="cursor-pointer font-semibold text-cyan-300">
                        Smogon Strategies:
                      </summary>
                      <div class="mt-2 pl-1 flex space-x-4 overflow-x-auto max-w-full strategy-carousel">
                        {% for strategy in hint.strategies %}
                          <div class="min-w-[240px] max-w-xs bg-gray-800 border border-cyan-600 rounded-lg p-3 shadow-md">
                            <h4 class="text-yellow-400 font-bold text-sm mb-1">{{ strategy.label }}</h4>
                            <div class="text-white text-xs strategy-content">
                              {{ strategy.html|safe }}
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </details>
                  {% endif %}
              {% elif hint.text %}
                <span>{{ hint.text|safe }}</span>
              {% endif %}          
              </li>
            {% endfor %}
          </ul>
        </div>

        {% if not is_daily %}
        <div class="flex flex-col items-center mt-4 space-y-1 bg-gray-900/60 backdrop-blur-md rounded-xl px-4 py-3 border border-indigo-500/30 shadow-md transition-all duration-300">
          <div id="floating-points-container" class="relative h-24"></div>
        
          <h2 id="reward-header" class="text-3xl font-extrabold tracking-wider text-white mb-2 transition duration-500">
            Current Rewards
          </h2>

          {% if is_daily %}
            <div class="text-yellow-300 font-semibold text-lg mb-2 animate-bounce">
              Daily Challenge x10 Bonus!
            </div>
          {% endif %}
        
          <div class="flex items-center justify-center space-x-6 text-xl">
            <div class="flex items-center space-x-3 text-cyan-300 font-extrabold">
              <img src="/static/icons/point.png" alt="Points" class="w-10 h-10">
              <span>Score:</span>
              <span id="score-value" class="text-2xl">{{ score }}</span>
            </div>
            <div class="flex items-center space-x-3 text-yellow-400 font-extrabold">
              <img src="/static/icons/pokedollar.png" alt="Pok√©dollars" class="w-10 h-10">
              <span id="pokedollars-value" class="text-2xl">Pok√©dollars: {{ pokedollars_total }}</span>
            </div>
          </div>
            <div id="points-float-container" class="relative h-4 w-full"></div>
            <div id="pokedollars-float-container" class="relative h-4 w-full"></div>
          <div id="rounds-display" class="text-xl font-semibold text-blue-200">
            Rounds: {{ rounds }}
          </div>
          <button onclick="openSettings()" class="p-2 rounded-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:brightness-110 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9.75 3a1.75 1.75 0 00-1.75 1.75v1.232a7.014 7.014 0 00-1.272.743l-.872-.872a1.75 1.75 0 10-2.475 2.475l.872.872c-.345.39-.635.81-.872 1.272H4.75A1.75 1.75 0 003 9.75v4.5A1.75 1.75 0 004.75 16h1.232c.237.462.527.882.872 1.272l-.872.872a1.75 1.75 0 102.475 2.475l.872-.872c.39.345.81.635 1.272.872v1.232A1.75 1.75 0 009.75 21h4.5A1.75 1.75 0 0016 19.25v-1.232a7.014 7.014 0 001.272-.872l.872.872a1.75 1.75 0 102.475-2.475l-.872-.872c.345-.39.635-.81.872-1.272h1.232A1.75 1.75 0 0021 14.25v-4.5A1.75 1.75 0 0019.25 8h-1.232a7.014 7.014 0 00-.872-1.272l.872-.872a1.75 1.75 0 00-2.475-2.475l-.872.872c-.39-.345-.81-.635-1.272-.872V4.75A1.75 1.75 0 0014.25 3h-4.5z" />
              <circle cx="12" cy="12" r="3" />
            </svg>
          </button>              
        </div>
        {% endif %}

        {% if image_revealed and (last_correct or gave_up_reveal) %}
        <div class="text-center mb-6">
          <h3 class="text-green-400 text-2xl font-bold mb-2">Correct!</h3>
          {% if bonus_multiplier %}
          <div class="text-indigo-400 font-bold text-md mt-1 animate-bounce">x1.5 Bonus!</div>
          {% endif %}
          <div class="relative w-40 h-40 mx-auto perspective mb-4">
            <div class="flip-card-inner">
              <div class="flip-card-front bg-gray-600 rounded-xl shadow"></div>
              <div class="flip-card-back bg-gray-200 rounded-xl shadow flex items-center justify-center">
                <img src="{{ image_url }}" alt="Pokemon Sprite" class="w-28 h-28 object-contain">
              </div>
            </div>
          </div>
          <div class="flex justify-center gap-4">
            <a href="/next" id="next-button" class="px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700">Next Pok√©mon</a>
            <a href="/reset" class="px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700">Start Over</a>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% if user %}
    <div class="fixed right-0 top-1/3 transform -translate-y-1/2 bg-gray-800 border-l-4 border-cyan-400 rounded-l-lg p-4 shadow-lg w-60 z-50 hover:w-72 transition-all duration-300 overflow-hidden">
      <h3 class="text-cyan-300 font-bold text-lg mb-2">Achievements</h3>
      <ul class="text-sm text-blue-200 space-y-2">
        <li class="flex justify-between items-center font-semibold text-cyan-200">
          <span>Total Points</span>
          <span>{{ user.total_score }}</span>
        </li>
        {% if user_streak %}
          <li class="flex justify-between items-center text-yellow-300 font-semibold">
            <span>üî• Streak</span>
            <span>{{ user_streak }} days</span>
          </li>
        {% endif %}
      </ul>
      <button onclick="document.getElementById('achievements-modal').classList.remove('hidden')" class="mt-4 px-3 py-1 bg-cyan-700 text-white text-sm rounded hover:bg-cyan-600 transition">
        View All Achievements
      </button>
      <div class="mt-4 text-sm text-yellow-400 font-semibold">
        <div class="flex justify-between">
          <span>Pok√©dollars</span>
          <span>{{ user.pokedollars or 0 }}</span>
        </div>
      </div>
      <a href="/shop" class="mt-2 inline-block px-3 py-1 bg-yellow-500 text-white text-sm rounded hover:bg-yellow-400 transition">
        Visit Shop
      </a>
    </div>
    {% endif %}    
    <div class="text-center mt-6 flex justify-center items-center gap-4">
      {% if user %}
        <p class="inline-block px-4 py-1 bg-indigo-700 text-cyan-200 rounded-full text-sm font-medium">
          Logged in as: {{ user.username }}
        </p>
        <a href="/profile" class="inline-block px-4 py-1 bg-purple-700 text-white rounded-full text-sm font-medium hover:brightness-110 transition">
          View Profile
        </a>
        <a href="/logout" class="text-sm text-cyan-300 hover:text-cyan-400 underline">
          Log out
        </a>
      {% else %}
        <p class="text-blue-200">
          You are not logged in.
          <a href="/login" class="underline text-cyan-300 hover:text-cyan-400">Log in?</a>
        </p>
      {% endif %}
    </div>    
    {% if session.get("is_admin") == 1 %}
      <a href="/admin" class="text-indigo-400 hover:underline text-sm ml-4">Admin Panel</a>
    {% endif %}
  </div>

<script>
  particlesJS("particles-js", {
    particles: {
      number: { value: 40 },
      color: { value: "#bbbbff" },
      shape: { type: "circle" },
      opacity: { value: 0.5 },
      size: { value: 3 },
      move: { enable: true, speed: 0.5 }
    },
    interactivity: { detect_on: "canvas", events: { onhover: { enable: false } } },
    retina_detect: true
  });
</script>
<script>
  function clearGuessBox() {
    const guessInput = document.getElementById('guess-input');
    if (guessInput) {
      guessInput.value = '';
    }
  }

  {% if image_revealed and (last_correct or gave_up_reveal) %}
  // If the guess was correct, clear the input box
  window.addEventListener('load', function() {
    clearGuessBox();
  });
  {% endif %}

  function showHintToast(hintLabel) {
    if (hintLabel === "NoMoreHints") return;

    const toast = document.createElement("div");
    toast.className = "hint-toast";

    const icons = {
      "Tier": "üìä",
      "Types": "üî∂",
      "Abilities": "‚ú®",
      "Stats": "üìà",
      "Smogon Strategies": "‚öîÔ∏è",
      "ID": "üÜî"
    };

    const friendlyNames = {
      "Tier": "Tier",
      "Types": "Types",
      "Abilities": "Abilities",
      "Stats": "Stats",
      "Smogon Strategies": "Smogon Strategies",
      "ID": "ID"
    };

    const icon = icons[hintLabel] || "üí°";
    const displayName = friendlyNames[hintLabel] || hintLabel;

    toast.innerHTML = `${icon} Hint revealed: <strong>${displayName}</strong>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2800);
  }

  function showGiveUpToast() {
    const toast = document.createElement('div');
    toast.className = 'hint-toast';
    toast.innerText = '‚ùå You gave up. Better luck next time!';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2800);
  }

  function showGiveUpAnswerToast(pokemonName) {
    const toast = document.createElement('div');
    toast.className = 'hint-toast answer-toast';
    toast.innerText = `üß† It was ${pokemonName}!`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  {% if new_hint_label %}
    window.addEventListener("load", () => {
      showHintToast("{{ new_hint_label }}");
    });
  {% endif %}

  {% if gave_up %}
    window.addEventListener("load", () => {
      showGiveUpToast();
    });
  {% endif %}

  {% if gave_up_answer %}
    window.addEventListener("load", () => {
      showGiveUpAnswerToast("{{ gave_up_answer }}");
    });
  {% endif %}

</script>
<script>
  function createFallingStar() {
    const isBright = Math.random() < 0.05; // 5% chance = ~1 in 20 stars
    const star = document.createElement("div");
  
    if (isBright) {
      star.classList.add("bright-star");
    } else {
      star.classList.add("falling-star");
    }
  
    // Random horizontal position
    const left = Math.random() * window.innerWidth;
    star.style.left = `${left}px`;
  
    // Slight random animation delay (for variation)
    const delay = Math.random() * 0.5;
    star.style.animationDelay = `${delay}s`;
  
    // Append and remove after animation
    document.getElementById('cinematics-layer').appendChild(star);
    setTimeout(() => {
      star.remove();
    }, isBright ? 3500 : 5500); // bright stars are faster, so remove earlier
  }
  
  setInterval(() => {
    if (!cinematicsEnabled) return; // If cinematics off, skip all visual events

    const random = Math.random();

    if (random < 0.05) { 
      createSupernova();
    } else if (random < 0.5) { 
      createFallingStar();
    }

    if (Math.random() < 0.1) {
      createFlyingStar();
    }
  }, 6000);

  function createSupernova() {
    const supernova = document.createElement("div");
    supernova.style.position = "absolute";
    supernova.style.top = `${Math.random() * window.innerHeight}px`;
    supernova.style.left = `${Math.random() * window.innerWidth}px`;
    supernova.style.width = "100px";
    supernova.style.height = "100px";
    supernova.style.borderRadius = "50%";
    supernova.style.background = "radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 70%)";
    supernova.style.opacity = "0";
    supernova.style.zIndex = "-3";
    supernova.style.pointerEvents = "none";
    supernova.style.animation = "supernova-flash 1.5s ease-out forwards";
    
    document.getElementById('cinematics-layer').appendChild(supernova);

    setTimeout(() => {
      supernova.remove();
    }, 1600);
  }
  function createFlyingStar() {
    const flyingStar = document.createElement("div");
    flyingStar.classList.add("flying-star");

    // Random vertical starting position (10% to 60%)
    const randomTop = 10 + Math.random() * 50;
    flyingStar.style.top = `${randomTop}%`;

    // Random small flight tilt
    const randomAngle = (Math.random() - 0.5) * 20; // -10deg to +10deg
    flyingStar.style.transform = `rotate(${randomAngle}deg)`;

    document.getElementById('cinematics-layer').appendChild(flyingStar);

    setTimeout(() => {
      flyingStar.remove();
    }, 16000); // a bit longer than the animation
  }
  </script>
<script>
  function showFloatingPoints(points, isPerfect) {
    const container = document.getElementById('points-float-container');

    // 1. Icon + Points
    const iconText = document.createElement('div');
    iconText.className = 'fly-left-fast';
    iconText.innerHTML = `
      <img src="/static/icons/point.png" style="height: 32px; vertical-align: middle; margin-right: 10px;">
      <span style="font-size: 1.75rem; font-weight: 800; color: #7dd3fc; text-shadow: 0 0 10px #7dd3fc;">+${points}</span>
    `;
    container.appendChild(iconText);

    // 2. Optional "Perfect!" tag
    if (isPerfect) {
      const perfectText = document.createElement('div');
      perfectText.className = 'fly-left-medium';
      perfectText.style.color = '#7dd3fc';
      perfectText.style.textShadow = '0 0 10px #7dd3fc';
      perfectText.style.fontSize = '2rem';
      perfectText.style.fontWeight = 'bold';
      perfectText.innerText = 'Perfect!';
      container.appendChild(perfectText);

      setTimeout(() => perfectText.remove(), 1600);
    }

    setTimeout(() => iconText.remove(), 1500);
  }

  function showFloatingPokedollars(amount, isPerfect) {
    const container = document.getElementById('pokedollars-float-container');

    // 1. Icon + Dollars
    const iconText = document.createElement('div');
    iconText.className = 'fly-right-fast';
    iconText.innerHTML = `
      <img src="/static/icons/pokedollar.png" style="height: 32px; vertical-align: middle; margin-right: 10px;">
      <span style="font-size: 1.75rem; font-weight: 800; color: #facc15; text-shadow: 0 0 10px #facc15;">+${amount}</span>
    `;
    container.appendChild(iconText);

    // 2. Optional "Perfect!" tag
    if (isPerfect) {
      const perfectText = document.createElement('div');
      perfectText.className = 'fly-right-slow';
      perfectText.style.color = '#facc15';
      perfectText.style.textShadow = '0 0 10px #facc15';
      perfectText.style.fontSize = '2rem';
      perfectText.style.fontWeight = 'bold';
      perfectText.innerText = 'Perfect!';
      container.appendChild(perfectText);

      setTimeout(() => perfectText.remove(), 1800);
    }

    setTimeout(() => iconText.remove(), 1500);
  }

  function showCorrectFloat() {
    const inputBox = document.getElementById("guess-input");
    const rect = inputBox.getBoundingClientRect();

    const floatDiv = document.createElement("div");
    floatDiv.className = "correct-float";
    floatDiv.innerText = "Correct!";

    // Position absolutely within the document
    floatDiv.style.left = `${rect.left + rect.width / 2}px`;
    floatDiv.style.top = `${rect.top}px`;
    floatDiv.style.position = "fixed";
    floatDiv.style.transform = "translate(-50%, 0)";
    floatDiv.style.fontSize = '2.25rem';
    floatDiv.style.color = '#facc15'; // bright gold
    floatDiv.style.textShadow = '0 0 12px #facc15, 0 0 20px #facc15';
    floatDiv.style.animation = 'correct-burst 1.2s ease-out forwards';

    document.body.appendChild(floatDiv);

    setTimeout(() => {
      floatDiv.remove();
    }, 1500);
  }
</script>
{% if points_earned %}
  <script>
    const isPerfect = {{ 'true' if is_perfect else 'false' }};
    showFloatingPoints({{ points_earned }}, isPerfect);
    showFloatingPokedollars({{ pokedollars_earned }}, isPerfect);
    showCorrectFloat();
  </script>
{% endif %}
{% if image_revealed and last_correct %}
<script>
  window.addEventListener('load', () => {
    launchConfetti();
  });
</script>
<script>
  window.addEventListener('load', () => {
    const header = document.getElementById('reward-header');
    if (header) {
      header.classList.add('glow-on-correct');
      setTimeout(() => {
        header.classList.remove('glow-on-correct');
      }, 6000);  // shimmer duration
    }
  });
</script>
{% endif %}
<!-- Settings Modal -->
<div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-indigo-800 p-8 rounded-lg w-96 space-y-6">
    <h2 class="text-2xl text-cyan-300 font-bold text-center">Settings</h2>

    <div class="flex items-center justify-between">
      <span class="text-blue-100">Auto Advance</span>
      <label class="relative inline-flex items-center cursor-pointer">
        <input type="checkbox" id="auto-advance-toggle" class="sr-only peer">
        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-cyan-400 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:h-5 after:w-5 after:rounded-full after:transition-all peer-checked:after:translate-x-full"></div>
      </label>
    </div>
    
    <div class="flex items-center justify-between">
      <span class="text-blue-100">Music</span>
      <label class="relative inline-flex items-center cursor-pointer">
        <input type="checkbox" id="music-toggle" class="sr-only peer">
        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-cyan-400 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:h-5 after:w-5 after:rounded-full after:transition-all peer-checked:after:translate-x-full"></div>
      </label>
    </div>

    <div class="flex items-center justify-between">
      <span class="text-blue-100">Cinematics</span>
      <label class="relative inline-flex items-center cursor-pointer">
        <input type="checkbox" id="cinematics-toggle" class="sr-only peer">
        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:bg-cyan-400 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:h-5 after:w-5 after:rounded-full after:transition-all peer-checked:after:translate-x-full"></div>
      </label>
    </div>

    <form method="POST" action="/restart" class="flex justify-center mt-6">
      <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition">Restart</button>
    </form>

    <div class="flex justify-center">
      <button onclick="closeSettings()" class="text-cyan-300 mt-4 hover:text-cyan-400">Close</button>
    </div>
  </div>
</div>
<!-- Filters Modal -->
<div id="filters-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
  <div class="bg-indigo-900 rounded-lg p-8 space-y-6 w-80 shadow-2xl">
    <h2 class="text-2xl font-bold text-cyan-300 text-center mb-4">Filters</h2>

    <!-- Tiers form inside Filters modal -->
    <form method="POST" action="/update_tiers" id="filters-form" class="flex flex-wrap gap-2 justify-center">
      {% for tier in tiers %}
        <label class="tier-button relative flex items-center justify-center px-4 py-2 rounded-lg cursor-pointer transition duration-300 bg-indigo-800 border-2 border-transparent hover:brightness-110 peer-checked:border-cyan-400 peer-checked:bg-cyan-700 peer-checked:scale-105 peer-checked:text-white">
          <input type="checkbox" name="tiers" value="{{ tier }}" class="sr-only peer" {% if tier in selected_tiers %}checked{% endif %}>
          <span class="text-blue-200 peer-checked:text-white font-semibold">
            {{ tier }}
            {% if tier_tracker and tier in tier_tracker %}
              <span class="text-xs text-gray-400 ml-1">({{ tier_tracker[tier] }})</span>
            {% endif %}
          </span>
        </label>
      {% endfor %}
      <div class="w-full flex justify-center mt-6">
        <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-700 to-indigo-600 text-white rounded-xl hover:brightness-110 transition duration-300">
          Apply Filters
        </button>
      </div>
    </form>

    <div class="flex justify-center">
      <button onclick="closeFilters()" class="mt-4 text-blue-300 hover:text-cyan-400">
        Close
      </button>
    </div>
  </div>
</div>
<!-- Leaderboard Modal -->
<div id="leaderboard-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
  <div class="bg-indigo-900 rounded-lg p-8 space-y-6 w-96 shadow-2xl">
    <h2 class="text-2xl font-bold text-cyan-300 text-center mb-4">Daily Leaderboard</h2>
    <ul id="leaderboard-list" class="space-y-2 text-center text-blue-200">
      <!-- Scores will be dynamically inserted here -->
    </ul>
    <div class="flex justify-center">
      <button onclick="closeLeaderboard()" class="mt-4 text-blue-300 hover:text-cyan-400">
        Close
      </button>
    </div>
  </div>
</div>
<!-- Login Prompt Modal -->
<div id="login-prompt-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
  <div class="bg-indigo-900 rounded-lg p-8 space-y-6 w-80 shadow-2xl">
    <h2 class="text-2xl font-bold text-cyan-300 text-center mb-4">Login Required</h2>
    <p class="text-blue-200 text-center">You must log in to compete in the Daily Challenge.</p>
    <div class="flex justify-center mt-4 space-x-4">
      <a href="/login" class="px-6 py-2 bg-gradient-to-r from-green-500 to-cyan-400 text-white rounded-xl hover:brightness-110 transition duration-300">
        Login
      </a>
      <button onclick="closeLoginPrompt()" class="px-6 py-2 bg-gray-600 text-white rounded-xl hover:bg-gray-700 transition">
        Cancel
      </button>
    </div>
  </div>
</div>
<!-- Already Played Modal -->
<div id="already-played-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
  <div class="bg-indigo-900 rounded-lg p-8 space-y-6 w-80 shadow-2xl">
    <h2 class="text-2xl font-bold text-cyan-300 text-center mb-4">Already Completed</h2>
    <p class="text-blue-200 text-center">You've already completed the Daily Challenge today. Come back tomorrow!</p>
    <div class="flex justify-center mt-4">
      <button onclick="closeAlreadyPlayed()" class="px-6 py-2 bg-gray-600 text-white rounded-xl hover:bg-gray-700 transition">
        Close
      </button>
    </div>
  </div>
</div>
<!-- Achievements Modal -->
{% if user %}
<div id="achievements-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50">
  <div class="bg-gray-900 text-white rounded-lg p-8 w-full max-w-xl shadow-xl relative">
    <h2 class="text-3xl font-bold text-cyan-300 text-center mb-6">Achievements Gallery</h2>
    <ul class="space-y-3 max-h-[60vh] overflow-y-auto px-2">
      {% for badge, date in user_achievements.items() %}
      <li class="flex justify-between bg-gray-800 p-3 rounded-lg shadow">
        <span class="font-semibold text-cyan-200">{{ badge }}</span>
        <span class="text-sm text-gray-400">{{ date }}</span>
      </li>
      {% endfor %}
      
      {% for name, progress in progress_data.items() %}
        {% if name not in user_achievements %}
        <li class="bg-gray-800 p-3 rounded-lg shadow">
          <div class="flex justify-between">
            <span class="font-semibold text-gray-300" title="{{ ACHIEVEMENTS_REV[name]['description'] }}">{{ name }}</span>
            <span class="text-sm text-gray-400">{{ progress.current }}/{{ progress.total }}</span>
          </div>
          {% set percent = (progress.current / progress.total * 100) if progress.total > 0 else 0 %}
          <div class="w-full bg-gray-600 rounded h-2 mt-1">
            <div class="{% if percent >= 90 %}bg-yellow-500{% else %}bg-cyan-400{% endif %} h-2 rounded"
                 style="width: {{ 100 if percent > 100 else percent }}%;">
            </div>
          </div>          
        </li>
        {% endif %}
      {% endfor %}
      {% if not user_achievements %}
      <li class="text-center text-gray-400 italic">No achievements earned yet.</li>
      {% endif %}
    </ul>
    <div class="flex justify-center mt-6">
      <button onclick="document.getElementById('achievements-modal').classList.add('hidden')" class="px-6 py-2 bg-indigo-700 text-white rounded hover:bg-indigo-600">
        Close
      </button>
    </div>
  </div>
</div>
{% endif %}
{% if show_name_entry %}
<script>
  window.addEventListener('load', () => {
    const modal = document.createElement('div');
    modal.className = "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50";
    modal.innerHTML = `
      <div class="bg-indigo-900 rounded-lg p-8 space-y-6 w-96 shadow-2xl text-center">
        <h2 class="text-2xl font-bold text-cyan-300">Submit Your Score?</h2>
        <p class="text-blue-200">Log in to post your Daily Challenge result to the leaderboard!</p>
        <div class="mt-6 flex justify-center gap-4">
          <a href="/login" class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white rounded-xl">Log In</a>
          <a href="/reset" class="px-6 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-xl">Skip</a>
        </div>
      </div>`;
    document.body.appendChild(modal);
  });
</script>
{% endif %}
<script>
  document.getElementById("auto-advance-toggle").addEventListener("change", function () {
    fetch("/set_auto_advance", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ enabled: this.checked })
    });
  });

  // Set the toggle state from the server-side session variable
  window.addEventListener("load", () => {
    const state = {{ 'true' if session.get("auto_advance", True) else 'false' }};
    document.getElementById("auto-advance-toggle").checked = state;
  });
</script>
<script>

  let cinematicsEnabled = true;

  document.querySelectorAll('input[name="tiers"]').forEach(tierCheckbox => {
    tierCheckbox.addEventListener('change', (e) => {
      const label = e.target.closest('label');
      label.classList.add('animate-click-pop');
      setTimeout(() => {
        label.classList.remove('animate-click-pop');
      }, 300); // match animation duration
    });
  });

  document.querySelectorAll('.tier-button').forEach(label => {
    label.addEventListener('click', (e) => {
      const checkbox = label.querySelector('input[type="checkbox"]');
      if (checkbox) {
        checkbox.checked = !checkbox.checked; // Toggle manually

        // Animate pop
        label.classList.add('animate-click-pop');
        setTimeout(() => {
          label.classList.remove('animate-click-pop');
        }, 300); // match animation duration

        // Do NOT submit form here anymore
      }
    });
  });

  window.addEventListener('load', () => {
    document.body.classList.add('loaded');
  });

  window.addEventListener('scroll', function() {
    document.body.style.backgroundPositionY = -(window.scrollY * 0.2) + 'px';
  });

  window.addEventListener('load', () => {
    const guessInput = document.getElementById('guess-input');
    if (guessInput) {
      guessInput.focus();
    }
  });
  
  const guessForm = document.querySelector('form[action="/guess"]');
  if (guessForm) {
    guessForm.addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent immediate submit

      const delay = maybeTriggerCosmicEvent(); // üöÄ Get the correct delay

      setTimeout(() => {
        guessForm.submit(); // Submit after appropriate delay
      }, delay);

      setTimeout(() => {
        const guessInput = document.getElementById('guess-input');
        if (guessInput) {
          guessInput.focus();
        }
      }, delay + 100); // Refocus after submit
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const guessInput = document.getElementById('guess-input');
    const guessForm = document.querySelector('form[action="/guess"]');
    
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        const nextButton = document.getElementById('next-button');
  
        if (nextButton && nextButton.offsetParent !== null) {
          // If next button is visible, trigger it
          event.preventDefault();
          nextButton.click();
        } else {
          // Otherwise normal guess submit
          if (document.activeElement === guessInput) {
            // Let form submit naturally
          } else {
            event.preventDefault();
            if (guessInput) {
              guessInput.focus();
            }
          }
        }
      }
    });
  });

  function maybeTriggerCosmicEvent() {
    const roll = Math.random();
    if (roll < 0.003) {
      createAurora();
      return 2500;
    } else if (roll < 0.006) {
      createCosmicRipple();
      return 2000;
    } else if (roll < 0.02) {
      createMeteor();
      return 500;
    } else if (roll < 0.03) {
      createSableye();
      return 2000;
    }
    return 300;
  }
  
  function createMeteor() {
    const meteor = document.createElement('div');
    meteor.className = 'meteor';
    meteor.style.position = 'absolute';
    meteor.style.top = Math.random() * window.innerHeight * 0.7 + 'px';
    meteor.style.left = '-100px';
    meteor.style.width = '8px';
    meteor.style.height = '8px';
    meteor.style.background = 'white';
    meteor.style.borderRadius = '50%';
    meteor.style.boxShadow = '0 0 15px 5px white';
    meteor.style.zIndex = 5;
    document.getElementById('cinematics-layer').appendChild(meteor);

    meteor.animate([
      { transform: 'translateX(0) translateY(0)' },
      { transform: 'translateX(120vw) translateY(100px)' }
    ], {
      duration: 4000,
      easing: 'ease-out'
    });

    setTimeout(() => meteor.remove(), 4000);
  }
  
  function createCosmicRipple() {
    const ripple = document.createElement('div');
    ripple.className = 'cosmic-ripple';
    ripple.style.position = 'fixed'; /* not absolute! */
    ripple.style.top = '50%';
    ripple.style.left = '50%';
    ripple.style.transform = 'translate(-50%, -50%)';
    ripple.style.width = '150px';
    ripple.style.height = '150px';
    ripple.style.border = '3px solid cyan';
    ripple.style.borderRadius = '50%';
    ripple.style.opacity = '0.8';
    ripple.style.zIndex = 2; /* BELOW game card */
    ripple.style.pointerEvents = 'none';
    document.body.appendChild(ripple);

    ripple.animate([
      { transform: 'translate(-50%, -50%) scale(1)', opacity: 0.8 },
      { transform: 'translate(-50%, -50%) scale(6)', opacity: 0 }
    ], {
      duration: 2500,
      easing: 'ease-out'
    });

    setTimeout(() => ripple.remove(), 2500);
  }
  
  function createAurora() {
    const aurora = document.createElement('div');
    aurora.className = 'aurora';
    aurora.style.position = 'fixed'; /* not absolute! */
    aurora.style.top = '0';
    aurora.style.left = '0';
    aurora.style.width = '100%';
    aurora.style.height = '300px';
    aurora.style.background = 'linear-gradient(to bottom, rgba(0,255,255,0.4), transparent)';
    aurora.style.zIndex = 2; /* BELOW game cards */
    aurora.style.pointerEvents = 'none';
    document.body.appendChild(aurora);

    aurora.animate([
      { opacity: 0 },
      { opacity: 0.7 },
      { opacity: 0 }
    ], {
      duration: 6000,
      easing: 'ease-in-out'
    });

    setTimeout(() => aurora.remove(), 6000);
  }

  function createSableye() {
    const sableye = document.createElement('img');
    sableye.src = '/static/sableye.png'; // ‚úÖ Correct clean static path
    sableye.style.position = 'fixed';
    sableye.style.bottom = '20px';
    sableye.style.right = '-150px'; // Start fully off-screen
    sableye.style.width = '100px';
    sableye.style.height = 'auto';
    sableye.style.zIndex = 10;
    sableye.style.filter = 'drop-shadow(0 0 10px cyan) drop-shadow(0 0 20px purple)';
    sableye.style.opacity = '0.9';
    sableye.style.transition = 'right 2s ease-out';

    document.body.appendChild(sableye);

    // Slide it into position
    setTimeout(() => {
      sableye.style.right = '20px';
    }, 100);

    // After it's parked, start shimmerglow animation
    setTimeout(() => {
      sableye.animate([
        { filter: 'drop-shadow(0 0 10px cyan) drop-shadow(0 0 20px purple)', opacity: 0.9 },
        { filter: 'drop-shadow(0 0 20px cyan) drop-shadow(0 0 40px purple)', opacity: 1 },
        { filter: 'drop-shadow(0 0 10px cyan) drop-shadow(0 0 20px purple)', opacity: 0.9 }
      ], {
        duration: 3000,
        iterations: Infinity
      });
    }, 2100); // After sliding animation finishes
  }

  function launchConfetti() {
    const duration = 2 * 1000;
    const animationEnd = Date.now() + duration;
    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 11 };

    const interval = setInterval(() => {
      const timeLeft = animationEnd - Date.now();
      if (timeLeft <= 0) {
        return clearInterval(interval);
      }

      const particleCount = 25 * (timeLeft / duration);
      confetti({
        ...defaults,
        particleCount,
        origin: { x: 0.15, y: 0.5 }, // Left side
        colors: ['#facc15', '#3b82f6', '#38bdf8'] // yellow, blue, cyan
      });
      confetti({
        ...defaults,
        particleCount,
        origin: { x: 0.85, y: 0.5 }, // Right side
        colors: ['#facc15', '#3b82f6', '#38bdf8']
      });
    }, 200);
  }

document.addEventListener('DOMContentLoaded', function() {

  function saveToggleStates() {
    const musicToggle = document.getElementById('music-toggle').checked;
    const cinematicsToggle = document.getElementById('cinematics-toggle').checked;
    localStorage.setItem('musicEnabled', musicToggle);
    localStorage.setItem('cinematicsEnabled', cinematicsToggle);
  }

  function loadToggleStates() {
    const musicState = localStorage.getItem('musicEnabled');
    const cinematicsState = localStorage.getItem('cinematicsEnabled');

    if (musicState !== null) {
      document.getElementById('music-toggle').checked = (musicState === 'true');
    }
    if (cinematicsState !== null) {
      document.getElementById('cinematics-toggle').checked = (cinematicsState === 'true');
    }
  }

  loadToggleStates();

  document.getElementById('music-toggle').addEventListener('change', saveToggleStates);
  document.getElementById('cinematics-toggle').addEventListener('change', saveToggleStates);

  });
    
</script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<audio id="background-music" loop autoplay hidden>
  <source src="/static/background-music.mp3" type="audio/mpeg">
</audio>
<script>
  function openSettings() {
    document.getElementById('settings-modal').classList.remove('hidden');
  }
  function closeSettings() {
    document.getElementById('settings-modal').classList.add('hidden');
  }
  
  function openFilters() {
    document.getElementById('filters-modal').classList.remove('hidden');
  }
  function closeFilters() {
    document.getElementById('filters-modal').classList.add('hidden');
  }
  
  function openLeaderboard() {
    document.getElementById('leaderboard-modal').classList.remove('hidden');
    fetchLeaderboard();
  }
  function closeLeaderboard() {
    document.getElementById('leaderboard-modal').classList.add('hidden');
  }
  function openLoginPrompt() {
    document.getElementById('login-prompt-modal').classList.remove('hidden');
  }
  function closeLoginPrompt() {
    document.getElementById('login-prompt-modal').classList.add('hidden');
  }
  
  function fetchLeaderboard() {
  fetch('/leaderboard')
    .then(response => response.json())
    .then(data => {
      const list = document.getElementById('leaderboard-list');
      list.innerHTML = '';

      if (data.length === 0) {
        list.innerHTML = '<li class="text-blue-300">No scores yet today!</li>';
      } else {
        data.forEach(([name, score, time], index) => {
          const li = document.createElement('li');
          
          let medal = "";
          if (index === 0) {
            medal = "ü•á ";
          } else if (index === 1) {
            medal = "ü•à ";
          } else if (index === 2) {
            medal = "ü•â ";
          }

          li.innerHTML = `
            <span class="text-indigo-300 font-bold">${medal}${index + 1}. ${name}</span> 
            <span class="text-cyan-300">- ${score} pts</span> 
            <span class="text-purple-300">‚è± ${Math.round(time)}s</span>
          `;
          
          list.appendChild(li);
        });
      }
    });
}
</script>
{% if daily_already_played %}
<script>
window.addEventListener('load', () => {
  document.getElementById('already-played-modal').classList.remove('hidden');
});
</script>
{% endif %}
{% if show_leaderboard %}
<script>
window.addEventListener('load', () => {
  openLeaderboard();
});
</script>
{% endif %}
<script>
  window.addEventListener('load', () => {
    const scoreDisplay = document.getElementById('score-display');
    const roundsDisplay = document.getElementById('rounds-display');
  
    {% if score == 0 %}
      if (scoreDisplay) {
        scoreDisplay.classList.add('animate-score-pop');
        setTimeout(() => scoreDisplay.classList.remove('animate-score-pop'), 500);
      }
    {% endif %}
  
    {% if rounds == 0 %}
      if (roundsDisplay) {
        roundsDisplay.classList.add('animate-score-pop');
        setTimeout(() => roundsDisplay.classList.remove('animate-score-pop'), 500);
      }
    {% endif %}
  });
</script>
<script>
  function closeAlreadyPlayed() {
    document.getElementById('already-played-modal').classList.add('hidden');
  }
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const showFirstWin = {{ show_first_win_popup|tojson }};
    if (showFirstWin) {
      const popup = document.createElement("div");
      popup.className = "fixed top-1/4 left-1/2 transform -translate-x-1/2 bg-indigo-800 text-white px-6 py-4 rounded-xl shadow-lg z-50 text-center max-w-md";
      popup.innerHTML = `
        <h2 class="text-2xl font-bold text-yellow-300 mb-2">üéâ Congratulations!</h2>
        <p class="mb-3">You've earned your <strong>First Win</strong> achievement!</p>
        <p class="text-sm text-gray-200">To make the game flow more smoothly, <strong>Auto Advance</strong> has now been enabled. You can disable this anytime in Settings.</p>
        <button onclick="this.parentElement.remove()" class="mt-4 px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded">Got it!</button>
      `;
      document.body.appendChild(popup);
    }
  });
</script>
{% if new_achievements %}
<script>
  window.addEventListener('load', () => {
    const messages = {{ new_achievements|tojson }};
    messages.forEach((msg, idx) => {
      setTimeout(() => {
        const toast = document.createElement('div');
        toast.innerText = `üèÜ Achievement Unlocked: ${msg}`;
        toast.className = 'fixed top-6 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg text-lg z-50 animate-slide-fade-up';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3500);
      }, idx * 4000); // Delay between multiple toasts
    });
  });
</script>
{% endif %}
<style>
  html, body {
    height: 100%;
    background-repeat: no-repeat;
    background-size: cover;
    background-attachment: fixed;
  }

  #cinematics-layer {
    min-height: 100vh;
  }
</style>
</body>
</html>
